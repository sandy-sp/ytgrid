name: üê≥ Build & Push Docker Image (On Docker File Changes)

on:
  push:
    branches:
      - main  # Only trigger when pushing to main branch
    paths:
      - 'Dockerfile'
      - 'docker-compose.yml'
      - 'supervisord.conf'  # Tracks changes in process management
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-and-push:
    name: üöÄ Build & Publish Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: üõ†Ô∏è Checkout Repository
        uses: actions/checkout@v4

      - name: üê≥ Log in to Docker Hub
        run: echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
        env:
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: üîë Log in to GitHub Container Registry
        run: echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}

      - name: üèóÔ∏è Build Docker Image
        run: |
          IMAGE_NAME=ytgrid
          DOCKERHUB_USER="${{ secrets.DOCKER_HUB_USERNAME }}"  # Docker Hub username from secrets
          GHCR_USER="${{ github.repository_owner }}"  # GitHub Packages owner (from repository)

          DOCKERHUB_IMAGE="$DOCKERHUB_USER/$IMAGE_NAME"
          GHCR_IMAGE="ghcr.io/$GHCR_USER/$IMAGE_NAME"

          echo "üê≥ Building Docker Images:"
          echo "‚û°Ô∏è Docker Hub: $DOCKERHUB_IMAGE:latest"
          echo "‚û°Ô∏è GHCR: $GHCR_IMAGE:latest"

          # Build images
          docker build -t $DOCKERHUB_IMAGE:latest .
          docker build -t $GHCR_IMAGE:latest .


      - name: üì§ Push to Docker Hub
        run: |
          IMAGE_NAME=ytgrid
          docker push $DOCKER_HUB_USERNAME/$IMAGE_NAME:latest

      - name: üì§ Push to GitHub Packages
        run: |
          IMAGE_NAME=ytgrid
          docker push ghcr.io/$GITHUB_REPOSITORY:latest
